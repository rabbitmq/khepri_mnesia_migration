<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Module mnesia_to_khepri</title>
<link rel="stylesheet" type="text/css" href="edoc-extensions.css" title="EDoc">
<link rel="icon" href="kmm-favicon.svg" type="image/svg+xml">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-fork-ribbon-css/0.2.3/gh-fork-ribbon.min.css" />
</head>
<body class="markdown-body language-erlang"><script src="prism.js"></script>
<div class="navbar"><a name="#navbar_top"></a><table width="100%" border="0" cellspacing="0" cellpadding="2" summary="navigation bar"><tr><td><a href="overview-summary.html" target="overviewFrame">Overview</a></td><td><a href="http://www.erlang.org/"><img src="erlang.png" align="right" border="0" alt="erlang logo"></a></td></tr></table></div>
<hr>

<h1>Module mnesia_to_khepri</h1>
<ul class="index"><li><a href="#description">Description</a></li><li><a href="#types">Data Types</a></li><li><a href="#index">Function Index</a></li><li><a href="#functions">Function Details</a></li></ul>Tools to migrate from Mnesia to Khepri.


<h2><a name="description">Description</a></h2><p>Tools to migrate from Mnesia to Khepri.</p>
 
  The migration from Mnesia to Khepri implemented in this module is divided in
  two distinct parts:
  <ol>
  <li>the cluster membership</li>
  <li>the tables content</li>
  </ol>
 
  <p>Both parts can be used independently.</p>
 
  <h3><a name="Cluster_membership_synchronization">Cluster membership synchronization</a></h3>
 
  <p>For the first part, <a docgen-rel="seemfa" docgen-href="#sync_cluster_membership/0" href="#sync_cluster_membership-0"><code>sync_cluster_membership/0</code></a> and <a docgen-rel="seemfa" docgen-href="#sync_cluster_membership/1" href="#sync_cluster_membership-1"><code>sync_cluster_membership/1</code></a> ensure the default/specified Khepri store has the  
same cluster members as Mnesia.</p>
 
  <p>All "instances" of the Khepri store on unclustered nodes will be reset
  except one. The selected surviving Khepri store is determined using several
  heuristics which are explained in <a docgen-rel="seemfa" docgen-href="#sync_cluster_membership/1" href="#sync_cluster_membership-1"><code>sync_cluster_membership/1</code></a>.</p>
 
  <h3><a name="Tables_copy">Tables copy</a></h3>
 
  <p>For the second part, <a docgen-rel="seemfa" docgen-href="#copy_tables/3" href="#copy_tables-3"><code>copy_tables/3</code></a>, <a docgen-rel="seemfa" docgen-href="#copy_tables/4" href="#copy_tables-4"><code>copy_tables/4</code></a>, <a docgen-rel="seemfa" docgen-href="#copy_all_tables/1" href="#copy_all_tables-1"><code>copy_all_tables/1</code></a> and <a docgen-rel="seemfa" docgen-href="#copy_all_tables/2" href="#copy_all_tables-2"><code>copy_all_tables/2</code></a> take care of copying  
records to the designated Khepri store.</p>
 
  <p>The functions take a converter module which is responsible for actually
  writing the given table name and record to wherever it wants in the Khepri
  store. This allows the caller to filter and convert the records. The
  converter module interface is defined by the <a docgen-rel="seeerl" docgen-href="mnesia_to_khepri_converter" href="mnesia_to_khepri_converter.html"><code>mnesia_to_khepri_converter</code></a> behavior. There is an example converter module
  called <a docgen-rel="seeerl" docgen-href="mnesia_to_khepri_example_converter" href="mnesia_to_khepri_example_converter.html"><code>mnesia_to_khepri_example_converter</code></a> provided.</p>
 
  <p>The copy works while Mnesia tables are still being used and updated. To
  allow that, the copy follows several stages which are explained in <a docgen-rel="seemfa" docgen-href="#copy_tables/4" href="#copy_tables-4"><code>copy_tables/4</code></a>.</p>
 
  <p>The functions <a docgen-rel="seemfa" docgen-href="#is_migration_finished/1" href="#is_migration_finished-1"><code>is_migration_finished/1</code></a>, <a docgen-rel="seemfa" docgen-href="#is_migration_finished/2" href="#is_migration_finished-2"><code>is_migration_finished/2</code></a>, <a docgen-rel="seemfa" docgen-href="#wait_for_migration/2" href="#wait_for_migration-2"><code>wait_for_migration/2</code></a> and <a docgen-rel="seemfa" docgen-href="#wait_for_migration/3" href="#wait_for_migration-3"><code>wait_for_migration/3</code></a> can be used to follow an on-going copy of tables.</p>
 
  Finally to help with the use of the Mnesia tables and Khepri store
  concurrently with a tables copy, you can use <a docgen-rel="seemfa" docgen-href="#handle_fallback/2" href="#handle_fallback-2"><code>handle_fallback/2</code></a> and
  <a docgen-rel="seemfa" docgen-href="#handle_fallback/3" href="#handle_fallback-3"><code>handle_fallback/3</code></a>.
<h2><a name="types">Data Types</a></h2>

<h3 class="typedecl"><a name="type-converter_mod">converter_mod()</a></h3>
<p><code>converter_mod() = module() | {module(), any()}</code></p>
<p><p>  A converter module, possibly with a private term to initliaze it.</p>
 
  A converter module is a module implementing the <a docgen-rel="seeerl" docgen-href="mnesia_to_khepri_converter" href="mnesia_to_khepri_converter.html"><code>mnesia_to_khepri_converter</code></a> behavior. The private term is passed as is to
  its {link mnesia_to_khepri_converter:init_copy_to_khepri/3} callback.</p>

<h3 class="typedecl"><a name="type-migration_id">migration_id()</a></h3>
<p><code>migration_id() = binary()</code></p>
<p><p>  MigrationId of a migration.</p>
 
  <p>This is used to semantically identify a migration that covers a set of  
Mnesia tables and an associated converter module.</p>
 
  A migration is idempotent, based on this identifier. In other words, a
  migration identifier by this identifier can happen only once, and there
  can't be concurrent migration processes with that same identifier.</p>

<h3 class="typedecl"><a name="type-mnesia_table">mnesia_table()</a></h3>
<p><code>mnesia_table() = atom()</code></p>
<p><p>  The name of a Mnesia table.</p>
 
  This is the same type as <code>mnesia:table()</code> which is not exported
  unfortunately.</p>

<h2><a name="index">Function Index</a></h2>
<table width="100%" border="1" cellspacing="0" cellpadding="2" summary="function index"><tr><td valign="top"><a href="#sync_cluster_membership-0">sync_cluster_membership/0</a></td><td>Ensures the default Khepri store has the same members as the Mnesia
  cluster.</td></tr>
<tr><td valign="top"><a href="#sync_cluster_membership-1">sync_cluster_membership/1</a></td><td>Ensures the Khepri store named <code>StoreId</code> has the same members as the  
Mnesia cluster.</td></tr>
<tr><td valign="top"><a href="#copy_tables-3">copy_tables/3</a></td><td>Copies records from Mnesia tables <code>Tables</code> to the default Khepri
  store.</td></tr>
<tr><td valign="top"><a href="#copy_tables-4">copy_tables/4</a></td><td>Copies records from Mnesia tables <code>Tables</code> to the Khepri store named
  <code>StoreId</code>.</td></tr>
<tr><td valign="top"><a href="#copy_all_tables-2">copy_all_tables/2</a></td><td>Copies records from all Mnesia tables to the default Khepri store.</td></tr>
<tr><td valign="top"><a href="#copy_all_tables-3">copy_all_tables/3</a></td><td>Copies records from all Mnesia tables to the Khepri store named
  <code>StoreId</code>.</td></tr>
<tr><td valign="top"><a href="#is_migration_finished-1">is_migration_finished/1</a></td><td>Returns the migration status of the specified migration identifier.</td></tr>
<tr><td valign="top"><a href="#is_migration_finished-2">is_migration_finished/2</a></td><td>Returns the migration status of the specified migration identifier.</td></tr>
<tr><td valign="top"><a href="#wait_for_migration-2">wait_for_migration/2</a></td><td>Waits for migration <code>MigrationId</code> to be finish.</td></tr>
<tr><td valign="top"><a href="#wait_for_migration-3">wait_for_migration/3</a></td><td>Waits for migration <code>MigrationId</code> to be finish.</td></tr>
<tr><td valign="top"><a href="#cleanup_after_migration-1">cleanup_after_migration/1</a></td><td>Performs any cleanups after a migration has finished.</td></tr>
<tr><td valign="top"><a href="#cleanup_after_migration-2">cleanup_after_migration/2</a></td><td>Performs any cleanups after a migration has finished.</td></tr>
<tr><td valign="top"><a href="#handle_fallback-3">handle_fallback/3</a></td><td>Runs <code>MnesiaFun</code> or evaluates <code>KhepriFunOrRet</code> depending on the status  
of the migration.</td></tr>
<tr><td valign="top"><a href="#handle_fallback-4">handle_fallback/4</a></td><td>Runs <code>MnesiaFun</code> or evaluates <code>KhepriFunOrRet</code> depending on the status  
of the migration.</td></tr>
</table>

<h2><a name="functions">Function Details</a></h2>

<h3 class="function"><a name="sync_cluster_membership-0">sync_cluster_membership/0</a></h3>
<div class="spec">
<p><code>sync_cluster_membership() -&gt; ok</code><br></p>
<p></p>
</div><p>Ensures the default Khepri store has the same members as the Mnesia
  cluster.
 </p>
<p><b>See also:</b> <a href="#sync_cluster_membership-1">sync_cluster_membership/1</a>.</p>

<h3 class="function"><a name="sync_cluster_membership-1">sync_cluster_membership/1</a></h3>
<div class="spec">
<p><code>sync_cluster_membership(StoreId) -&gt; ok</code>
<ul class="definitions"><li><code>StoreId = <a href="/home/runner/work/khepri_mnesia_migration/khepri/doc/khepri.html#type-store_id">khepri:store_id()</a></code></li></ul></p>
<p></p>
</div><p><p>Ensures the Khepri store named <code>StoreId</code> has the same members as the  
Mnesia cluster.</p>
 
  The synchronization is split into the following steps:
  <ol>
  <li>Mnesia is queried to list all its members. We ensure that all Mnesia
  members are running at this point: if some members are down, there is
  little chance that Khepri will work on those anyway.</li>
  <li>All Mnesia members are queried to learn about the membership status of
  all "instances" of the Khepri store named <code>StoreId</code>.</li>
  <li>Among all instances of the Khepri store, one instance is selected to be
  the one that will be joined by other nodes. The selection process is
  described below.</li>
  <li>Other nodes are reset, meaning their data is dropped, and they are
  added to the selected Khepri store.</li>
  </ol>
 
  <p>The synchronization process has to select a store instance that will grow  
and other store instances that will be reset. The criterias below are  
evaluated to sort the list of store instances, then the first instance in  
that list is selected as the winning instance.</p>
 
  <p>Criterias are evaluated in order. For a given criteria, if both sides are  
equal, the next criteria is evaluated until one criteria gives an instance  
"greater" than another.</p>
 
  Here is the ordered list of criterias:
  <ol>
  <li>A Khepri store instance with more members gets precedence.</li>
  <li>Then, a Khepri store instance with more tree nodes (more records) gets
  precedence.</li>
  <li>Then, a Khepri store instance where a member's Erlang node runs for the
  longest time gets precedence.</li>
  <li>Then, a Khepri store instance where its members list sorts before
  another members list gets precedence.</li>
  </ol>
 
  Here are some examples:
  <ul>
  <li>A Khepri store instance with 3 members will be selected before another
  Khepri store instance with 1 member.</li>
  <li>If they have the same number of members, a Khepri store instance with
  125 tree nodes will be selected before another Khepri store instance with
  34 tree nodes.</li>
  <li>If they have the same number of members and the same number of tree
  nodes, a Khepri store instance where the oldest Erlang node runs for 67
  days will be selected before another Khepri store instance where the oldest
  Erlang node runs for 3 days.</li>
  </ul></p>

<h3 class="function"><a name="copy_tables-3">copy_tables/3</a></h3>
<div class="spec">
<p><code>copy_tables(MigrationId, Tables, Mod) -&gt; Ret</code>
<ul class="definitions"><li><code>MigrationId = <a href="#type-migration_id">migration_id()</a></code></li><li><code>Tables = [<a href="#type-mnesia_table">mnesia_table()</a>]</code></li><li><code>Mod = <a href="#type-converter_mod">converter_mod()</a> | {<a href="#type-converter_mod">converter_mod()</a>, ModArgs}</code></li><li><code>ModArgs = any()</code></li><li><code>Ret = ok | {error, any()}</code></li></ul></p>
<p></p>
</div><p>Copies records from Mnesia tables <code>Tables</code> to the default Khepri
  store.
 </p>
<p><b>See also:</b> <a href="#copy_tables-3">copy_tables/3</a>.</p>

<h3 class="function"><a name="copy_tables-4">copy_tables/4</a></h3>
<div class="spec">
<p><code>copy_tables(StoreId, MigrationId, Tables, Mod) -&gt; Ret</code>
<ul class="definitions"><li><code>StoreId = <a href="/home/runner/work/khepri_mnesia_migration/khepri/doc/khepri.html#type-store_id">khepri:store_id()</a></code></li><li><code>MigrationId = <a href="#type-migration_id">migration_id()</a></code></li><li><code>Tables = [<a href="#type-mnesia_table">mnesia_table()</a>]</code></li><li><code>Mod = <a href="#type-converter_mod">converter_mod()</a> | {<a href="#type-converter_mod">converter_mod()</a>, ModArgs}</code></li><li><code>ModArgs = any()</code></li><li><code>Ret = ok | {error, any()}</code></li></ul></p>
<p></p>
</div><p><p>Copies records from Mnesia tables <code>Tables</code> to the Khepri store named
  <code>StoreId</code>.</p>
 
  <p>The converter module <code>Mod</code> is responsible for storing each Mnesia record in
  the Khepri store. How it is called is described below. <a docgen-rel="seeerl" docgen-href="mnesia_to_khepri_example_converter" href="mnesia_to_khepri_example_converter.html"><code>mnesia_to_khepri_example_converter</code></a> can be used as the default converter  
module or as an example to write a new one.</p>
 
  The copy is split into the following steps:
  <ol>
  <li>The PID of the Erlang process working on the copy is stored in the
  Khepri store. This serves as an indicator that tables are being copied and
  this prevents concurrent copy from happening.</li>
  <li>The converter module state is initialized using its
  <code>Mod:init_copy_to_khepri/3</code> function, or <code>Mod:init_copy_to_khepri/4</code> if
  <code>ModArgs</code> is set.</li>
  <li>The copy process subscribes to changes from Mnesia.</li>
  <li>The copy process copies records from Mnesia using its Backup &amp;
  Restore API. The process uses <code>Mod:copy_to_khepri/3</code> for each Mnesia
  record.</li>
  <li>The copy process marks all involved Mnesia tables as read-only.</li>
  <li>The copy process consumes all Mnesia events it received during the
  initial copy and calls <code>Mod:copy_to_khepri/3</code> and
  <code>Mod:delete_from_khepri/3</code> to update the Khepri store accordingly.</li>
  <li>The copy process calls <code>Mod:finish_copy_to_khepri/1</code> to let the
  converter module do any cleanups.</li>
  <li>The "migration in progress" marker is removed from the Khepri
  store.</li>
  </ol>
 
  Copied Mnesia tables continue to be available during the process, except
  after they are marked as read-only. See <a docgen-rel="seemfa" docgen-href="#handle_fallback/2" href="#handle_fallback-2"><code>handle_fallback/2</code></a> and <a docgen-rel="seemfa" docgen-href="#handle_fallback/3" href="#handle_fallback-3"><code>handle_fallback/3</code></a> for helpers to use Mnesia while records are being copied.</p>

<h3 class="function"><a name="copy_all_tables-2">copy_all_tables/2</a></h3>
<div class="spec">
<p><code>copy_all_tables(MigrationId, Mod) -&gt; Ret</code>
<ul class="definitions"><li><code>MigrationId = <a href="#type-migration_id">migration_id()</a></code></li><li><code>Mod = <a href="#type-converter_mod">converter_mod()</a> | {<a href="#type-converter_mod">converter_mod()</a>, ModArgs}</code></li><li><code>ModArgs = any()</code></li><li><code>Ret = ok | {error, any()}</code></li></ul></p>
<p></p>
</div><p>Copies records from all Mnesia tables to the default Khepri store.
 </p>
<p><b>See also:</b> <a href="#copy_all_tables-3">copy_all_tables/3</a>.</p>

<h3 class="function"><a name="copy_all_tables-3">copy_all_tables/3</a></h3>
<div class="spec">
<p><code>copy_all_tables(StoreId, MigrationId, Mod) -&gt; Ret</code>
<ul class="definitions"><li><code>StoreId = <a href="/home/runner/work/khepri_mnesia_migration/khepri/doc/khepri.html#type-store_id">khepri:store_id()</a></code></li><li><code>MigrationId = <a href="#type-migration_id">migration_id()</a></code></li><li><code>Mod = <a href="#type-converter_mod">converter_mod()</a> | {<a href="#type-converter_mod">converter_mod()</a>, ModArgs}</code></li><li><code>ModArgs = any()</code></li><li><code>Ret = ok | {error, any()}</code></li></ul></p>
<p></p>
</div><p>Copies records from all Mnesia tables to the Khepri store named
  <code>StoreId</code>.
 </p>
<p><b>See also:</b> <a href="#copy_tables-4">copy_tables/4</a>.</p>

<h3 class="function"><a name="is_migration_finished-1">is_migration_finished/1</a></h3>
<div class="spec">
<p><code>is_migration_finished(MigrationId) -&gt; Migrated</code>
<ul class="definitions"><li><code>MigrationId = <a href="/home/runner/work/khepri_mnesia_migration/khepri_mnesia_migration/doc/mnesia_to_khepri.html#type-migration_id">mnesia_to_khepri:migration_id()</a></code></li><li><code>Migrated = boolean() | {in_flight, pid()} | undefined</code></li></ul></p>
<p></p>
</div><p><p>Returns the migration status of the specified migration identifier.</p>
 
  The default Khepri store is queried to get the migration status. It must
  correspond to the Khepri store passed to <a docgen-rel="seemfa" docgen-href="#copy_tables/3" href="#copy_tables-3"><code>copy_tables/3</code></a> and similar
  functions.
 </p>
<p><b>See also:</b> <a href="#is_migration_finished-2">is_migration_finished/2</a>.</p>

<h3 class="function"><a name="is_migration_finished-2">is_migration_finished/2</a></h3>
<div class="spec">
<p><code>is_migration_finished(StoreId, MigrationId) -&gt; Migrated</code>
<ul class="definitions"><li><code>StoreId = <a href="/home/runner/work/khepri_mnesia_migration/khepri/doc/khepri.html#type-store_id">khepri:store_id()</a></code></li><li><code>MigrationId = <a href="/home/runner/work/khepri_mnesia_migration/khepri_mnesia_migration/doc/mnesia_to_khepri.html#type-migration_id">mnesia_to_khepri:migration_id()</a></code></li><li><code>Migrated = boolean() | {in_flight, pid()} | undefined</code></li></ul></p>
<p></p>
<p>returns: <code>true</code> if the migration is finished, <code>{in_flight, Pid}</code> if the
  migration is in progress and handled by the <code>Pid</code> process, <code>false</code> if the
  migration has not started or <code>undefined</code> if the query of the Khepri store
  where the status is recorded failed.</p>
</div><p><p>Returns the migration status of the specified migration identifier.</p>
 
  The Khepri store named <code>StoreId</code> is queried to get the migration status. It
  must correspond to the Khepri store passed to <a docgen-rel="seemfa" docgen-href="#copy_tables/3" href="#copy_tables-3"><code>copy_tables/3</code></a> and
  similar functions.
 </p>

<h3 class="function"><a name="wait_for_migration-2">wait_for_migration/2</a></h3>
<div class="spec">
<p><code>wait_for_migration(MigrationId, Timeout) -&gt; Ret</code>
<ul class="definitions"><li><code>MigrationId = <a href="/home/runner/work/khepri_mnesia_migration/khepri_mnesia_migration/doc/mnesia_to_khepri.html#type-migration_id">mnesia_to_khepri:migration_id()</a></code></li><li><code>Timeout = timeout()</code></li><li><code>Ret = boolean() | timeout</code></li></ul></p>
<p></p>
</div><p><p>Waits for migration <code>MigrationId</code> to be finish.</p>
 
  The default Khepri store is queried to get the migration status. It must
  correspond to the Khepri store passed to <a docgen-rel="seemfa" docgen-href="#copy_tables/3" href="#copy_tables-3"><code>copy_tables/3</code></a> and similar
  functions.
 </p>
<p><b>See also:</b> <a href="#wait_for_migration-3">wait_for_migration/3</a>.</p>

<h3 class="function"><a name="wait_for_migration-3">wait_for_migration/3</a></h3>
<div class="spec">
<p><code>wait_for_migration(StoreId, MigrationId, Timeout) -&gt; Ret</code>
<ul class="definitions"><li><code>StoreId = <a href="/home/runner/work/khepri_mnesia_migration/khepri/doc/khepri.html#type-store_id">khepri:store_id()</a></code></li><li><code>MigrationId = <a href="/home/runner/work/khepri_mnesia_migration/khepri_mnesia_migration/doc/mnesia_to_khepri.html#type-migration_id">mnesia_to_khepri:migration_id()</a></code></li><li><code>Timeout = timeout()</code></li><li><code>Ret = boolean() | timeout</code></li></ul></p>
<p></p>
</div><p><p>Waits for migration <code>MigrationId</code> to be finish.</p>
 
  <p>If the migration has not started, it returns <code>false</code> immediately.</p>
 
  <p>If the migration is finished, it returns <code>true</code> immediately.</p>
 
  <p>If the migration is in progress or the status is undefined (see <a docgen-rel="seemfa" docgen-href="#is_migration_finished/3" href="#is_migration_finished-3"><code>is_migration_finished/3</code></a>), it waits until the status is known to be
  "finished" or "not started" or until <code>Timeout</code> milliseconds.</p>
 
  The Khepri store named <code>StoreId</code> is queried to get the migration status. It
  must correspond to the Khepri store passed to <a docgen-rel="seemfa" docgen-href="#copy_tables/3" href="#copy_tables-3"><code>copy_tables/3</code></a> and
  similar functions.</p>

<h3 class="function"><a name="cleanup_after_migration-1">cleanup_after_migration/1</a></h3>
<div class="spec">
<p><code>cleanup_after_migration(MigrationId) -&gt; Ret</code>
<ul class="definitions"><li><code>MigrationId = <a href="/home/runner/work/khepri_mnesia_migration/khepri_mnesia_migration/doc/mnesia_to_khepri.html#type-migration_id">mnesia_to_khepri:migration_id()</a></code></li><li><code>Ret = ok | {error, any()}</code></li></ul></p>
<p></p>
</div><p>Performs any cleanups after a migration has finished.
 </p>
<p><b>See also:</b> <a href="#cleanup_after_migration-2">cleanup_after_migration/2</a>.</p>

<h3 class="function"><a name="cleanup_after_migration-2">cleanup_after_migration/2</a></h3>
<div class="spec">
<p><code>cleanup_after_migration(StoreId, MigrationId) -&gt; Ret</code>
<ul class="definitions"><li><code>StoreId = <a href="/home/runner/work/khepri_mnesia_migration/khepri/doc/khepri.html#type-store_id">khepri:store_id()</a></code></li><li><code>MigrationId = <a href="/home/runner/work/khepri_mnesia_migration/khepri_mnesia_migration/doc/mnesia_to_khepri.html#type-migration_id">mnesia_to_khepri:migration_id()</a></code></li><li><code>Ret = ok | {error, any()}</code></li></ul></p>
<p></p>
</div><p><p>Performs any cleanups after a migration has finished.</p>
 
  <p>Currently this includes the deletion of the copied Mnesia tables.</p>
 
  This is a separate step from <a docgen-rel="seemfa" docgen-href="#copy_tables/4" href="#copy_tables-4"><code>copy_tables/4</code></a> because the caller might
  want to record some post-migration states before comitting to delete the
  Mnesia tables.</p>

<h3 class="function"><a name="handle_fallback-3">handle_fallback/3</a></h3>
<div class="spec">
<p><code>handle_fallback(MigrationId, MnesiaFun, KhepriFunOrRet) -&gt; Ret</code>
<ul class="definitions"><li><code>MigrationId = <a href="/home/runner/work/khepri_mnesia_migration/khepri_mnesia_migration/doc/mnesia_to_khepri.html#type-migration_id">mnesia_to_khepri:migration_id()</a></code></li><li><code>MnesiaFun = fun(() -&gt; Ret)</code></li><li><code>KhepriFunOrRet = fun(() -&gt; Ret) | Ret</code></li><li><code>Ret = any()</code></li></ul></p>
<p></p>
</div><p><p>Runs <code>MnesiaFun</code> or evaluates <code>KhepriFunOrRet</code> depending on the status  
of the migration.</p>
 
  The default Khepri store is queried to get the migration status. It must
  correspond to the Khepri store passed to <a docgen-rel="seemfa" docgen-href="#copy_tables/3" href="#copy_tables-3"><code>copy_tables/3</code></a> and similar
  functions.
 </p>
<p><b>See also:</b> <a href="#handle_fallback-4">handle_fallback/4</a>.</p>

<h3 class="function"><a name="handle_fallback-4">handle_fallback/4</a></h3>
<div class="spec">
<p><code>handle_fallback(StoreId, MigrationId, MnesiaFun, KhepriFunOrRet) -&gt; Ret</code>
<ul class="definitions"><li><code>StoreId = <a href="/home/runner/work/khepri_mnesia_migration/khepri/doc/khepri.html#type-store_id">khepri:store_id()</a></code></li><li><code>MigrationId = <a href="/home/runner/work/khepri_mnesia_migration/khepri_mnesia_migration/doc/mnesia_to_khepri.html#type-migration_id">mnesia_to_khepri:migration_id()</a></code></li><li><code>MnesiaFun = fun(() -&gt; Ret)</code></li><li><code>KhepriFunOrRet = fun(() -&gt; Ret) | Ret</code></li><li><code>Ret = any()</code></li></ul></p>
<p></p>
</div><p><p>Runs <code>MnesiaFun</code> or evaluates <code>KhepriFunOrRet</code> depending on the status  
of the migration.</p>
 
  <p>If the migration is finished it executes <code>KhepriFunOrRet</code> if it is a  
function with an arity of 0 or returns the term directly otherwise.</p>
 
  <p>If the migration is not finished, the function tries to execute
  <code>MnesiaFun</code>. It should fail by returning or raising <code>{aborted, {no_exists,
  Table}}</code>. When this happens, the function waits for the migration to finish
  using <a docgen-rel="seemfa" docgen-href="#wait_for_table_migration/3" href="#wait_for_table_migration-3"><code>wait_for_table_migration/3</code></a>, then it starts again.</p>
 
  The Khepri store named <code>StoreId</code> is queried to get the migration status. It
  must correspond to the Khepri store passed to <a docgen-rel="seemfa" docgen-href="#copy_tables/3" href="#copy_tables-3"><code>copy_tables/3</code></a> and
  similar functions.</p>
<hr>

<div class="navbar"><a name="#navbar_bottom"></a><table width="100%" border="0" cellspacing="0" cellpadding="2" summary="navigation bar"><tr><td><a href="overview-summary.html" target="overviewFrame">Overview</a></td><td><a href="http://www.erlang.org/"><img src="erlang.png" align="right" border="0" alt="erlang logo"></a></td></tr></table></div>
<p><i>Generated by EDoc</i></p>
</body>
</html>
